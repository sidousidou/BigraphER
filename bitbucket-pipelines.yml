image: ocaml/opam2:4.12

definitions:
  caches:
    apt: /var/cache/apt/archives/
    opam: ~/.opam/download-cache/
  steps:
    - step: &build-test
        name: Build and test
        script:
          - sudo apt-get -qy update && sudo apt-get -qy upgrade && sudo apt-get -qy install m4 zlib1g-dev minisat graphviz
          - opam repo set-url --all-switches default https://opam.ocaml.org/ && opam update && opam install -y dune dune-configurator menhir cmdliner jsonm
          - eval $(opam env)
          - ocamlc --version
          - dune runtest -j 4

pipelines:
  default:
  - parallel:
    - step:
          <<: *build-test
          image: ocaml/opam2:4.08
          name: Build and test - 4.08
    - step:
          <<: *build-test
          name: Build and test - latest
  tags:
    v*:
      - step:
        name: Static build
        script:
          - sudo apt-get -qy update && sudo apt-get -qy upgrade && sudo apt-get -qy install m4 zlib1g-dev minisat graphviz
          - opam repo set-url --all-switches default https://opam.ocaml.org/ && opam update && opam install -y dune dune-configurator menhir cmdliner jsonm odoc
          - eval $(opam env)
          - dune runtest -j 4
          - dune build -j 4 --profile=static bigrapher/src/bigrapher.exe
          - ldd _build/default/bigrapher/src/bigrapher.exe || echo "OK"
          - dune build -j 4 @doc
          - tar -czvf bigrapher-$BITBUCKET_TAG.tar.gz -C _build/default/bigrapher/src/ bigrapher.exe
          - tar -czvf doc.tar.gz -C _build/default/_doc/_html .
        artifacts:
          - bigrapher-$BITBUCKET_TAG.tar.gz
          - doc.tar.gz
      - step:
        script:
          - pipe: atlassian/bitbucket-upload-file:0.3.2
            variables:
            BITBUCKET_USERNAME: $BITBUCKET_USERNAME
            BITBUCKET_APP_PASSWORD: $BITBUCKET_APP_PASSWORD
            FILENAME: 'bigrapher-$BITBUCKET_TAG.tar.gz'