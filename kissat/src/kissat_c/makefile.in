CC=@CC@
CFLAGS=@CFLAGS@
LD=@LD@
AR=@AR@

VPATH=../../src:../../test

%.o: %.c ../../[st]*/*.h makefile
	$(CC) $(CFLAGS) -c $<

APPSRC=application.c handle.c parse.c witness.c

LIBSRT=$(sort $(wildcard ../../src/*.c))
LIBSUB=$(subst ../../src/,,$(LIBSRT))
LIBSRC=$(filter-out main.c $(APPSRC),$(LIBSUB))

APPOBJ=$(APPSRC:.c=.o)
LIBOBJ=$(LIBSRC:.c=.o)

INCLUDES=-I.

all: libkissat.a kissat

kissat: main.o $(APPOBJ) libkissat.a makefile
	$(LD) -o $@ $< $(APPOBJ) -L. -lkissat -lm

build.h:
	../../scripts/generate-build-header.sh > $@

collect.o: sort.c
dense.o: sort.c
propagate.o: assign.c
watch.o: sort.c

build.o: build.c build.h ../../[st]*/*.h makefile
	$(CC) $(CFLAGS) $(INCLUDES) -c $<

libkissat.a: $(LIBOBJ) makefile
	$(AR) -rcs $@ $(LIBOBJ)

ifeq (Darwin,$(shell uname))
   SHARED_LDFLAGS += -shared -Wl,-install_name,libkissat.so.1
else
   SHARED_LDFLAGS += -shared -Wl,-soname,libkissat.so.1
endif

libkissat.so: $(LIBOBJ) makefile
	$(LD) $(SHARED_LDFLAGS) -o $@ $(LIBOBJ)

.PHONY: all build.h
